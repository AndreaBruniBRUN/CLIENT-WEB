<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dati in Streaming</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>

    <style>
        #grafico {
            width: 100%;
            height: 300px;
        }
    </style>
</head>

<body>
    <canvas id="grafico"></canvas>
    <h1>Dati Ricevuti in Streaming:</h1>
    <div>
        <label for="x">X:</label>
        <input type="text" id="x" readonly>
    </div>
    <div>
        <label for="y">Y:</label>
        <input type="text" id="y" readonly>
    </div>
    <div>
        <label for="z">Z:</label>
        <input type="text" id="z" readonly>
    </div>

    <script>
        const indirizzoIPDelServer = '192.168.1.12';
        const eventSource = new EventSource(`https://${indirizzoIPDelServer}:443/index`);
        const datiGrafico = [];
        const tempoIniziale = moment();
        const canvas = document.getElementById('grafico').getContext('2d');

        const grafico = new Chart(canvas, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Dati',
                    data: datiGrafico,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.5)',
                    pointRadius: 1,
                    pointHoverRadius: 8,
                }]
            },
            options: {
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom'
                    },
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });

        const maxSize = 100;

        eventSource.onmessage = function (event) {
            const data = JSON.parse(event.data);

            const tempoTrascorso = moment().diff(tempoIniziale);

            // Aggiungi i dati accumulati all'array dei dati del grafico
            datiGrafico.push(...data);

            // Limita la dimensione dell'array
            if (datiGrafico.length > maxSize) {
                datiGrafico.splice(0, datiGrafico.length - maxSize); // Rimuovi i dati pi√π vecchi
            }

            grafico.update();

            document.getElementById('x').value = data[data.length - 1].x;
            document.getElementById('y').value = data[data.length - 1].y;
            document.getElementById('z').value = data[data.length - 1].z;
        };

        eventSource.onerror = function (error) {
            console.error('Errore nella connessione SSE:', error);
        };
    </script>
</body>

</html>
